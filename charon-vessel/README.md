# Charon Vessel ‚Äî Secure Atomic File Rotation Daemon

[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![C++17](https://img.shields.io/badge/C++-17-blue.svg)](https://en.cppreference.com/w/cpp/17)
[![POSIX](https://img.shields.io/badge/Platform-POSIX-lightgrey.svg)](#)
[![Linux](https://img.shields.io/badge/Linux-Supported-success.svg)](#)
[![FreeBSD](https://img.shields.io/badge/FreeBSD-Supported-success.svg)](#)
[![Status](https://img.shields.io/badge/Status-Operationally%20Prototype-6c757d)](#)

<!-- CI/CD -->
[![Charon Vessel CI/CD](https://github.com/nekhebet/nekhebet/actions/workflows/ci-cd.yml/badge.svg)](https://github.com/nekhebet/nekhebet/actions/workflows/ci-cd.yml)
[![CodeQL](https://github.com/nekhebet/nekhebet/actions/workflows/codeql.yml/badge.svg)](https://github.com/nekhebet/nekhebet/actions/workflows/codeql.yml)

**Charon Vessel** ‚Äî –¥–µ–º–æ–Ω —Ä–æ—Ç–∞—Ü–∏–∏ –∏ –æ—á–∏—Å—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–∞–∫ –µ–¥–∏–Ω—ã–π –Ω–∞—Ç–∏–≤–Ω—ã–π –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª –Ω–∞ C++17 –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ runtime.

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–µ–º–æ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å –Ω–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ (`fresh`) –∏ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –≤ –∞—Ä—Ö–∏–≤–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞. –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è **–∞—Ç–æ–º–∞—Ä–Ω–æ** —Å –ø–æ–ª–Ω–æ–π –∑–∞—â–∏—Ç–æ–π –æ—Ç race conditions, symlink-–∞—Ç–∞–∫ –∏ TOCTOU —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π.

### –ö–ª—é—á–µ–≤–∞—è –≥–∞—Ä–∞–Ω—Ç–∏—è:
> **–§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏–±–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ `fresh`, –ª–∏–±–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ `archive`. –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.**

## üìÅ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
Fresh Scanning (–ø–æ—Ç–æ–∫ 1)        Cleanup (–ø–æ—Ç–æ–∫ 2)
        ‚Üì                               ‚Üì
  –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏          –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –æ–±—Ö–æ–¥ archive
        ‚Üì                               ‚Üì
  –í—ã–±–æ—Ä —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤           –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ñ–∞–π–ª–æ–≤
        ‚Üì                               ‚Üì
  –ê—Ç–æ–º–∞—Ä–Ω—ã–π rename              –£–¥–∞–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
        ‚Üì                               ‚Üì
[EXDEV?] ‚Üí Cross-device Copy     –î–∏—Å–∫–æ–≤—ã–µ –∫–≤–æ—Ç—ã ‚Üí –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
        ‚Üì
  –ü—É–ª –ø–æ—Ç–æ–∫–æ–≤ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        ‚Üì
  –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
        ‚Üì
  Secure unlink –∏—Å—Ö–æ–¥–Ω–∏–∫–∞
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –°–±–æ—Ä–∫–∞

```bash
# –ë–∞–∑–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ (Linux/FreeBSD)
g++ -std=c++17 -pthread -O2 -DNDEBUG \
    -o charon_vessel charon_vessel.cpp

# –° –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π systemd (Linux)
g++ -std=c++17 -pthread -DHAS_SYSTEMD \
    -o charon_vessel charon_vessel.cpp -lsystemd

# –° –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π io_uring (Linux)
g++ -std=c++17 -pthread -DHAS_IO_URING \
    -o charon_vessel charon_vessel.cpp -luring
```

### –ó–∞–ø—É—Å–∫

```bash
# –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
export FRESH_PATH=/var/spool/fresh
export ARCHIVE_ROOT=/var/archive
export MAX_FRESH=1000
export ROTATION_SEC=7
export COPY_THREADS=8

./charon_vessel start
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–æ–π

```bash
# –ó–∞–ø—É—Å–∫ –¥–µ–º–æ–Ω–∞
./charon_vessel start

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
./charon_vessel stop

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏ –º–µ—Ç—Ä–∏–∫
./charon_vessel status

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è (–≤—Ä—É—á–Ω—É—é)
./charon_vessel force-rotate

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∞—Ä—Ö–∏–≤–∞
./charon_vessel force-cleanup          # –æ–±—ã—á–Ω–∞—è
./charon_vessel force-cleanup aggressive # –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------------|----------|---------|
| `FRESH_PATH` | –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –Ω–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ | `/mnt/data/fresh` |
| `ARCHIVE_ROOT` | –ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∞—Ä—Ö–∏–≤–∞ | `/mnt/archive` |

### –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –î–∏–∞–ø–∞–∑–æ–Ω |
|------------|----------|--------------|----------|
| `MAX_FRESH` | –ú–∞–∫—Å. —Ñ–∞–π–ª–æ–≤ –≤–æ fresh | 75 | ‚â•1 |
| `ROTATION_SEC` | –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–µ–∫) | 7 | ‚â•1 |
| `CLEANUP_MIN` | –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—á–∏—Å—Ç–∫–∏ (–º–∏–Ω) | 30 | ‚â•1 |
| `DISK_LIMIT_PCT` | –ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ (%) | 84 | 0-100 |
| `COPY_THREADS` | –ü–æ—Ç–æ–∫–æ–≤ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è | 8 | 1-32 |
| `MAX_AGE_DAYS` | –ú–∞–∫—Å. –≤–æ–∑—Ä–∞—Å—Ç —Ñ–∞–π–ª–æ–≤ (–¥–Ω–µ–π) | 1825 (5 –ª–µ—Ç) | ‚â•1 |
| `MAX_FILE_SIZE_GB` | –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (GB) | 10 | 1-100 |

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ |
|------------|----------|--------------|-----------|
| `USE_COPY_FILE_RANGE` | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å copy_file_range | yes | Linux/FreeBSD |
| `USE_SENDFILE` | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sendfile | no | Linux |
| `ENABLE_IO_URING` | –í–∫–ª—é—á–∏—Ç—å io_uring | no | Linux |
| `ADAPTIVE_BUFFER` | –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –±—É—Ñ–µ—Ä—ã | yes | –í—Å–µ |
| `COPY_CHUNK_KB` | –†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ (KB) | 128 | 4-16384 |

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|--------------|
| `SECURE_BUFFER_CLEAR` | –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–æ–≤ | no |
| `USE_XATTR_INDEX` | Xattr-–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ | yes (Linux) |
| `ENABLE_FAST_SCAN` | –ë—ã—Å—Ç—Ä–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ | yes |
| `USE_MEMFD` | Memfd –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã | yes (Linux) |
| `RUN_AS_USER` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø—Ä–∞–≤ | `charon` |
| `CHROOT_PATH` | Chroot jail | "" |

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—É–¥–∏—Ç

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|--------------|
| `USE_SYSLOG` | –õ–æ–≥–∏ –≤ syslog | yes |
| `ENABLE_AUDIT_LOG` | –ê—É–¥–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π | yes |
| `VERBOSE_LOGGING` | –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | no |
| `DAEMONIZE` | –ó–∞–ø—É—Å–∫ –∫–∞–∫ –¥–µ–º–æ–Ω | yes |

### –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
# –ü—É—Ç–∏
export FRESH_PATH=/mnt/storage/fresh
export ARCHIVE_ROOT=/mnt/storage/archive
export CHROOT_PATH=/mnt/storage/jail

# –õ–∏–º–∏—Ç—ã
export MAX_FRESH=5000
export ROTATION_SEC=5
export CLEANUP_MIN=15
export MAX_AGE_DAYS=365
export MAX_FILE_SIZE_GB=20
export DISK_LIMIT_PCT=90

# –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
export COPY_THREADS=16
export COPY_CHUNK_KB=256
export USE_COPY_FILE_RANGE=yes
export ENABLE_IO_URING=yes
export ADAPTIVE_BUFFER=yes

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
export RUN_AS_USER=charon
export USE_MEMFD=yes
export SECURE_BUFFER_CLEAR=yes
export USE_XATTR_INDEX=yes

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
export USE_SYSLOG=yes
export ENABLE_AUDIT_LOG=yes
export VERBOSE_LOGGING=no
export DAEMONIZE=yes
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ú–µ—Ä—ã –∑–∞—â–∏—Ç—ã

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Ç–µ–π**
   - –ó–∞—â–∏—Ç–∞ –æ—Ç traversal (`..`, `/./`)
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –ø—É—Ç–µ–π
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ null-–±–∞–π—Ç—ã

2. **TOCTOU –∑–∞—â–∏—Ç–∞**
   - FileIdentity (inode+mtime+size)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ –∏ –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–π
   - fstat vs lstat —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ

3. **Symlink –∑–∞—â–∏—Ç–∞**
   - `O_NOFOLLOW` –≤–µ–∑–¥–µ
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ inode/dev
   - –†—É—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è symlinks

4. **–ü—Ä–∏–≤–∏–ª–µ–≥–∏–∏**
   - –°–±—Ä–æ—Å UID/GID
   - Chroot –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
   - Dropping capabilities (Linux)

5. **–ê—É–¥–∏—Ç**
   - –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ `/var/log/charon-audit.log`
   - In-memory ring buffer (1024 –∑–∞–ø–∏—Å–µ–π)
   - –°–∞–Ω—Ç–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```cpp
1. –í—Å–µ –ø—É—Ç–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
2. –ù–∏–∫–∞–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏
3. –í—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ memfd (–Ω–µ –Ω–∞ –¥–∏—Å–∫–µ)
4. –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ renameat2 (RENAME_NOREPLACE)
5. fsync –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–π persistence
```

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –±—É—Ñ–µ—Ä—ã** - —Ä–∞–∑–º–µ—Ä –æ—Ç 16KB –¥–æ 64MB
2. **Zero-copy –æ–ø–µ—Ä–∞—Ü–∏–∏**
   - `copy_file_range` (Linux 4.5+, FreeBSD 13+)
   - `sendfile` (fallback)
   - `io_uring` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
3. **Lock-free —Å—Ç—Ä—É–∫—Ç—É—Ä—ã**
   - RingBuffer –¥–ª—è –∑–∞–¥–∞—á (1024 —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
   - Atomic –º–µ—Ç—Ä–∏–∫–∏
4. **Xattr-–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ stat –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
   - –ò–∑–±–µ–≥–∞–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
5. **–ü—É–ª –ø–æ—Ç–æ–∫–æ–≤**
   - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ (1-32 –ø–æ—Ç–æ–∫–∞)
   - –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ —Å–≤–æ–±–æ–¥–Ω–æ–º—É –º–µ—Å—Ç—É

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ API:

```c
// C API
int charon_get_metrics(char* buffer, size_t size);

// –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
rotated_total 15432
atomic_rename_success 14321
cross_device_moves 1111
active_copies 8
queued_tasks 0
errors 5
out_of_space 0
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –ü–æ—Ç–æ–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å

```
–ì–ª–∞–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
‚îú‚îÄ‚îÄ –°–∫–∞–Ω–µ—Ä (scanner_thread)
‚îÇ   ‚îú‚îÄ‚îÄ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ fresh –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
‚îÇ   ‚îî‚îÄ‚îÄ –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π
‚îú‚îÄ‚îÄ –û—á–∏—Å—Ç–∫–∞ (cleaner_thread)
‚îÇ   ‚îú‚îÄ‚îÄ –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –æ–±—Ö–æ–¥ archive
‚îÇ   ‚îú‚îÄ‚îÄ –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ –û—á–∏—Å—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
‚îî‚îÄ‚îÄ –ü—É–ª –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (CharonWorkerPool)
    ‚îú‚îÄ‚îÄ 1-32 —Ä–∞–±–æ—á–∏—Ö –ø–æ—Ç–æ–∫–æ–≤
    ‚îú‚îÄ‚îÄ RingBuffer –∑–∞–¥–∞—á
    ‚îî‚îÄ‚îÄ –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞
```

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–æ—Ç–∞—Ü–∏–∏

```cpp
1. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ fresh –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
2. –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ > MAX_FRESH:
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ mtime
   - –í—ã–±–æ—Ä N —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞:
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - –°–æ–∑–¥–∞–Ω–∏–µ –ø—É—Ç–∏ –∞—Ä—Ö–∏–≤–∞: YYYY/MM/DD/filename
   - –ê—Ç–æ–º–∞—Ä–Ω—ã–π rename
4. –ï—Å–ª–∏ rename –≤–µ—Ä–Ω—É–ª EXDEV:
   - –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ memfd temp
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
   - –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–º–µ–Ω–∞
```

### –ê–ª–≥–æ—Ä–∏—Ç–º –æ—á–∏—Å—Ç–∫–∏

```cpp
1. –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –æ–±—Ö–æ–¥ archive
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞:
   - –ï—Å–ª–∏ –∏–º—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å .charon.tmp. –∏ –≤–æ–∑—Ä–∞—Å—Ç > TEMP_GC_SEC:
     ‚Üí –£–¥–∞–ª–µ–Ω–∏–µ
   - –ï—Å–ª–∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏ –≤–æ–∑—Ä–∞—Å—Ç > MAX_AGE_DAYS:
     ‚Üí –£–¥–∞–ª–µ–Ω–∏–µ
3. –£–¥–∞–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
```

## üìù –§–æ—Ä–º–∞—Ç –∞—Ä—Ö–∏–≤–∞

```
ARCHIVE_ROOT/
‚îú‚îÄ‚îÄ 2024/
‚îÇ   ‚îú‚îÄ‚îÄ 01/          # –Ø–Ω–≤–∞—Ä—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01/      # 1 —è–Ω–≤–∞—Ä—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ file1.log
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ file2.dat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ 02/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ 2025/
‚îî‚îÄ‚îÄ ...
```

## üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### Systemd (Linux)

```ini
[Unit]
Description=Charon Vessel - Secure File Rotation
After=network.target local-fs.target
RequiresMountsFor=/mnt/storage

[Service]
Type=notify
NotifyAccess=main
ExecStart=/usr/local/bin/charon_vessel start
EnvironmentFile=/etc/charon.conf
Restart=on-failure
RestartSec=10
TimeoutStopSec=30

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
NoNewPrivileges=yes
ProtectSystem=strict
ReadWritePaths=/mnt/storage
PrivateTmp=yes
ProtectHome=yes

[Install]
WantedBy=multi-user.target
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# –ú–µ—Ç—Ä–∏–∫–∏ Prometheus
curl -s localhost:9090/metrics | grep charon_

# –ê—É–¥–∏—Ç –ª–æ–≥
tail -f /var/log/charon-audit.log

# –°—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ CLI
charon_vessel status
```

### C API –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

```c
#include <stddef.h>

#ifdef __cplusplus
extern "C" {
#endif

// –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
int charon_get_metrics(char* buffer, size_t size);

// –ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–æ—Ç–∞—Ç–æ—Ä–∞
void charon_start_background_rotator();
void charon_stop_background_rotator();

#ifdef __cplusplus
}
#endif
```

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

| –§—É–Ω–∫—Ü–∏—è | Linux | FreeBSD | –î—Ä—É–≥–∏–µ UNIX |
|---------|-------|---------|-------------|
| –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ | ‚úì | ‚úì | ‚úì |
| renameat2 | ‚úì | ‚úó | ‚úó |
| memfd | ‚úì | ‚úó | ‚úó |
| copy_file_range | ‚úì | ‚úì (13+) | ‚úó |
| io_uring | ‚úì | ‚úó | ‚úó |
| xattr –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è | ‚úì | ‚úó | ‚úó |
| capabilities | ‚úì | ‚úó | ‚úó |

### –§–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã

| FS | –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å rename | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è |
|----|-------------------|------------|
| ext4 | ‚úì | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| XFS | ‚úì | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| BTRFS | ‚úì | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| ZFS | ‚úì | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| NFSv4 | ‚ö†Ô∏è | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ |
| FUSE | ‚ö†Ô∏è | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ |

### –õ–∏–º–∏—Ç—ã

- –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 10GB (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- –ú–∞–∫—Å. –¥–ª–∏–Ω–∞ –ø—É—Ç–∏: `PATH_MAX - 100`
- –ú–∞–∫—Å. –≥–ª—É–±–∏–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π: 100
- –ú–∞–∫—Å. —Ñ–∞–π–ª–æ–≤ –≤ —Å–≤–µ–∂–µ–π –ø–∞–ø–∫–µ: 2^64-1

## üîç –û—Ç–ª–∞–¥–∫–∞ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
# –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
export VERBOSE_LOGGING=yes
./charon_vessel start

# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
export VERBOSE_LOGGING=no
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –±–µ–∑ –¥–µ–º–æ–Ω–∏–∑–∞—Ü–∏–∏
export DAEMONIZE=no
export VERBOSE_LOGGING=yes
./charon_vessel start
```

### –ê–≤–∞—Ä–∏–π–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

```bash
# –ï—Å–ª–∏ –¥–µ–º–æ–Ω –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
./charon_vessel stop
# –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç
kill -9 $(cat /var/run/charon/charon.pid)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∞—Ä—Ö–∏–≤–∞
find /mnt/archive -name ".charon.tmp.*" -delete
```

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

```bash
charon_vessel status
# –í—ã–≤–æ–¥:
rotated_total 15432           # –í—Å–µ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ —Ñ–∞–π–ª–æ–≤
atomic_rename_success 14321   # –£—Å–ø–µ—à–Ω—ã—Ö –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–π
cross_device_moves 1111       # –ö—Ä–æ—Å—Å-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–π
active_copies 8               # –ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–π —Å–µ–π—á–∞—Å
errors 5                      # –í—Å–µ–≥–æ –æ—à–∏–±–æ–∫
out_of_space 0                # –ù–µ—Ö–≤–∞—Ç–æ–∫ –º–µ—Å—Ç–∞
queue_full_rejections 0       # –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –∏–∑-–∑–∞ –ø–æ–ª–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏
security_errors 0             # –û—à–∏–±–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
```

### Prometheus —ç–∫—Å–ø–æ—Ä—Ç

```bash
# –ü—Ä–∏–º–µ—Ä —Å–∫—Ä–∏–ø—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
#!/bin/bash
METRICS=$(charon_vessel status 2>/dev/null || echo "")
echo "# HELP charon_rotated_total Total files rotated"
echo "# TYPE charon_rotated_total counter"
echo "charon_rotated_total $(echo "$METRICS" | grep rotated_total | awk '{print $2}')"
```


## üìö –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞

```bash
export FRESH_PATH=/var/log/nginx
export ARCHIVE_ROOT=/mnt/logs/archive
export MAX_FRESH=10000
export MAX_AGE_DAYS=30
export COPY_THREADS=4
./charon_vessel start
```

### –ü—Ä–∏–º–µ—Ä 2: –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ ETL

```bash
export FRESH_PATH=/etl/staging
export ARCHIVE_ROOT=/etl/processed
export MAX_FRESH=500
export ROTATION_SEC=30
export MAX_FILE_SIZE_GB=50
./charon_vessel start
```

### –ü—Ä–∏–º–µ—Ä 3: High-security –æ–∫—Ä—É–∂–µ–Ω–∏–µ

```bash
export FRESH_PATH=/secure/incoming
export ARCHIVE_ROOT=/secure/archive
export CHROOT_PATH=/secure
export RUN_AS_USER=charon
export SECURE_BUFFER_CLEAR=yes
export USE_MEMFD=yes
export ENABLE_AUDIT_LOG=yes
./charon_vessel start
```

## üîÑ –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

### 1. –§–æ–Ω–æ–≤—ã–π –¥–µ–º–æ–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```bash
./charon_vessel start  # –ó–∞–ø—É—Å–∫ —Å –¥–µ–º–æ–Ω–∏–∑–∞—Ü–∏–µ–π
```

### 2. Foreground —Ä–µ–∂–∏–º (–æ—Ç–ª–∞–¥–∫–∞)
```bash
export DAEMONIZE=no
export VERBOSE_LOGGING=yes
./charon_vessel start
```

### 3. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
```bash
# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è
./charon_vessel force-rotate

# –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –º–µ—Å—Ç–∞)
./charon_vessel force-cleanup aggressive

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
./charon_vessel status
```

### 4. Systemd integration
```bash
# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ systemd –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
export NOTIFY_SOCKET=/run/systemd/notify
./charon_vessel start
```

## üö® –ê–≤–∞—Ä–∏–π–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –ü–æ—Ç–µ—Ä—è –ø–∏—Ç–∞–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–∏
1. Memfd –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Ç–µ—Ä—è—é—Ç—Å—è (–æ–Ω–∏ –≤ RAM)
2. –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º
3. –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ ‚Äî –æ–ø–µ—Ä–∞—Ü–∏—è –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è

### –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏—Å–∫–∞
1. –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ statvfs
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
3. –†–µ–≥—É–ª–∏—Ä—É–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
1. –û–ø–µ—Ä–∞—Ü–∏–∏ fail-fast –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞
2. –ê—É–¥–∏—Ç –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –Ω–µ—É–¥–∞—á–∏
3. –î–µ–º–æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∏—Å–ø—Ä–∞–≤–Ω—ã–º–∏ –ø—É—Ç—è–º–∏

## üìñ –ì–ª–æ—Å—Å–∞—Ä–∏–π

| –¢–µ—Ä–º–∏–Ω | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ |
|--------|-------------|
| **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å** | –û–ø–µ—Ä–∞—Ü–∏—è –ª–∏–±–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é, –ª–∏–±–æ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤–æ–≤—Å–µ |
| **TOCTOU** | Time-Of-Check-Time-Of-Use ‚Äî —É—è–∑–≤–∏–º–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è |
| **Memfd** | –ê–Ω–æ–Ω–∏–º–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–º—è—Ç–∏ (Linux) |
| **EXDEV** | –û—à–∏–±–∫–∞ "cross-device link" –ø—Ä–∏ rename –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ |
| **Xattr** | Extended attributes ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–æ–≤ |
| **io_uring** | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π I/O –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Linux |

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License ‚Äî –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —Ñ–∞–π–ª–µ LICENSE.
